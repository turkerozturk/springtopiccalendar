<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!--
    This file is part of the DailyTopicTracker project.
    Please refer to the project's README.md file for additional details.
    https://github.com/turkerozturk/springtopiccalendar
    -->
    <meta charset="UTF-8"/>

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">



    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/css/all.min.css}">

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/2.3.0/css/dataTables.jqueryui.min.css}">







    <title>Topic List</title>


    <style>

        body {
        background-color: [[${htmlBackgroundColor}]];
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='77' height='107' viewBox='0 0 77 107'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='stamp-collection' fill='%239C92AC' fill-opacity='0.4'%3E%3Cpath d='M46 101a5 5 0 0 1 5 5h5a5 5 0 0 1 10 0h5a5 5 0 0 1 5-5v-5a5 5 0 0 1 0-10v-5a5 5 0 0 1 0-10v-5a5 5 0 0 1 0-10v-5a5 5 0 0 1 0-10v-5a5 5 0 0 1 0-10v-5a5 5 0 0 1 0-10V6a5 5 0 0 1-5-5h-5a5 5 0 0 1-10 0h-5a5 5 0 0 1-10 0h-5a5 5 0 0 1-10 0h-5a5 5 0 0 1-10 0H6a5 5 0 0 1-5 5v5a5 5 0 0 1 0 10v5a5 5 0 0 1 0 10v5a5 5 0 0 1 0 10v5a5 5 0 0 1 0 10v5a5 5 0 0 1 0 10v5a5 5 0 0 1 0 10v5a5 5 0 0 1 5 5h5a5 5 0 0 1 10 0h5a5 5 0 0 1 10 0h5a5 5 0 0 1 5-5zm15-2a7 7 0 0 0-6.71 5h-1.58a7 7 0 0 0-13.42 0h-1.58a7 7 0 0 0-13.42 0h-1.58a7 7 0 0 0-13.42 0H7.71A7.01 7.01 0 0 0 3 99.29v-1.58a7 7 0 0 0 0-13.42v-1.58a7 7 0 0 0 0-13.42v-1.58a7 7 0 0 0 0-13.42v-1.58a7 7 0 0 0 0-13.42v-1.58a7 7 0 0 0 0-13.42v-1.58A7 7 0 0 0 3 9.29V7.71A7.02 7.02 0 0 0 7.71 3h1.58a7 7 0 0 0 13.42 0h1.58a7 7 0 0 0 13.42 0h1.58a7 7 0 0 0 13.42 0h1.58a7 7 0 0 0 13.42 0h1.58A7.02 7.02 0 0 0 74 7.71v1.58a7 7 0 0 0 0 13.42v1.58a7 7 0 0 0 0 13.42v1.58a7 7 0 0 0 0 13.42v1.58a7 7 0 0 0 0 13.42v1.58a7 7 0 0 0 0 13.42v1.58a7 7 0 0 0 0 13.42v1.58a7.01 7.01 0 0 0-4.71 4.71h-1.58A7 7 0 0 0 61 99zM12 12h53v83H12V12zm51 81H14V14h49v79z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }



.status-0 {
           background-color: gainsboro !important;
}
.status-1 {
   background-color: palegreen !important;
}
.status-2 {
   background-color: tomato !important;
}
.status-3 {
   background-color: LightBlue !important;
}


#categorySelect {
/* max-width: 250px; *//* Genişliği sınırla */
 text-overflow: ellipsis;
 white-space: nowrap;
 overflow: hidden;
}



.fonbg {
   background: linear-gradient(90deg, rgba(203, 231, 242, 0.50) 0%, rgba(203, 242, 206, 1) 33%, rgba(242, 209, 203, 1) 66%, rgba(209, 209, 209, 0.50) 100%);
}

#topicsTable {


 background-color: WhiteSmoke;
 border: 3px solid black;
}
/* Mevcut link stilleri korundu */
a {
  text-decoration: none;
  color: inherit;
}
a:visited {
  color: inherit;
}
a:hover {
  color: blue;
}


/* Filtre satırına biraz görünüm kazandırmak isterseniz (opsiyonel) */
#topicsTable input.form-control {
  width: 100%; /* Hücrenin tamamını kaplasın */
}

.crop-text {
/*
white-space: nowrap;
overflow: hidden;
position: relative;
max-width: 200px;
*/
}







#navigation-panel button, a{
border-radius:10px !important;
}


#navigation-panel {
max-width: 740px;
margin-top: 10px;
margin-bottom: 5px;
margin-left: auto;
margin-right: auto;
padding: 3px;
border: 2px solid DarKGray;
border-radius: 7px 7px 7px 7px;

/* https://cssgradient.io/ */

background: #a7d6e8;
background: linear-gradient(90deg, rgba(203, 231, 242, 0.50) 0%, rgba(203, 242, 206, 1) 33%, rgba(242, 209, 203, 1) 66%, rgba(209, 209, 209, 0.50) 100%);
}

    </style>
</head>
    <body>


        <div  id="navigation-panel">
            <div th:replace="~{fragments/fragnavigation :: fragnavigation}"></div>

            <div>
                <!-- "Create New Topic" butonu -->
                <!-- eğer bir kategori seçili değilse (null ya da boş) parametre gönderme,
                     seçiliyse ?catId=xxx şeklinde gönder -->
                <a th:if="${selectedCategoryId != null}"
                   th:href="@{/topics/create(categoryId=${selectedCategoryId})}"
                   class="btn btn-secondary btn-sm" style="color:white; margin-top:4px;">
                    <i class="fa-solid fa-circle-plus"></i> New Topic
                </a>
                <a th:if="${selectedCategoryId == null}"
                   th:href="@{/topics/create}"
                   class="btn btn-secondary btn-sm" style="color:white; margin-top:4px;">
                    <i class="fa-solid fa-circle-plus"></i> New Topic
                </a>

                <a
                   th:href="@{/file-manager}"
                   class="btn btn-secondary btn-sm" style="color:white; margin-top:4px;">
                    <i class="fa-solid fa-circle-plus"></i>Image Manager
                </a>
            </div>
        </div>



        <!-- Hata mesajı varsa göster -->
        <div th:if="${errorMessage != null}" class="alert alert-danger" role="alert">
            <p th:text="${errorMessage}"></p>
        </div>

        <div class="container my-2">


            <h1><span class="fonbg">Topics</span></h1>

            <div style="width:100%; text-align:right; background-color:rgba(203, 231, 242, 0.50);">
                <span th:text="'Current Filter: ' + (${selectedCategoryName} != null ? ${selectedCategoryName} : 'None')">
                        Filter
                </span>
                &nbsp;

                <a class="btn btn-link p-0 ms-1" data-bs-toggle="collapse" href="#details" role="button">
                    <!-- selectedCategoryName controller tarafından geliyor; null ise 'None' göster -->
                    <span>
                        Expand Filter
                    </span>
                </a>
            </div>

            <div class="collapse mt-2" id="details">
                <div style="background-color:WhiteSmoke;">
                    <div class="row align-items-center mb-3">
                        <label for="categoryTextFilter" class="col-sm-4 col-form-label">Category Filter:</label>
                        <div class="col-auto">
                            <input type="text" id="categoryTextFilter" class="form-control" placeholder="Category Containing..">
                        </div>

                        <label for="categorySelect" class="col-auto col-form-label">Category: </label>
                        <div class="col-auto">
                            <select id="categorySelect" class="form-select" onchange="onCategoryChange()">
                                <!-- All = -1 -->
                                <option th:value="-1" th:selected="${selectedCategoryId == -1}">All</option>

                                <!-- Gerçek kategoriler -->
                                <option th:each="cat : ${categories}"
                                        th:value="${cat.id}"
                                        th:text="${cat.name}"
                                        th:selected="${cat.id == selectedCategoryId}">
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>




            <div style="background-color: white;">
                <!-- Topics Tablosu -->
                <table id="topicsTable"
                       class="table table-striped table-bordered table-sm align-middle"
                       style="margin-top: 10px; border-collapse: collapse;">
                    <thead>
                    <tr>
                        <th style="cursor: pointer;">ID</th>



                        <th style="cursor: pointer;">Topic Name</th>

                    </tr>


                    </thead>

                    <tbody>
                    <!-- iStat: https://www.baeldung.com/thymeleaf-iteration -->
                    <tr th:each="topic, iStat : ${topics}" th:with="zeroPaddedTopicId=${#numbers.formatInteger(topic.id, 5)}">

                        <td style="text-align:center;">
                            <span
                                    th:text="${zeroPaddedTopicId}">
                                topic id
                            </span>
                        </td>



                        <!-- Topic Name -->
                        <td>
                            <span th:text="${topic.name}" class="crop-text">
                                Sample Topic
                            </span>
                            <br/>





                            &nbsp;
                            <a th:href="@{/topics/delete/{id}(id=${topic.id})}"
                               onclick="return confirm('Are you sure to delete this topic?')"
                               title="Delete Topic">
                                🗑
                            </a>
                            &nbsp;
                            <a th:href="@{/entries/new(topicId=${topic.id}, returnPage='topics', categoryId=${topic.category.id})}"
                               title="Add Entry">
                                +
                            </a>
                            &nbsp;
                            <a th:href="@{/entries?topicId={id}(id=${topic.id})}"
                               th:text="'☰'"
                                title="List Entries">
                                Entries List
                            </a>
                            &nbsp;


                            <a
                                    th:href="@{/entries/weekly-calendar?topicId={id}(id=${topic.id})}"
                                    th:attr="hx-get=@{/entries/weekly-calendar(topicId=${topic.id}, fragment='true')}"
                                    hx-target="#modal-content"
                                    hx-trigger="click"
                                    hx-swap="innerHTML"
                                    onclick="document.getElementById('modal').style.display='block'; return false;"
                                    title="View Weekly Calendar";
                                    th:text="'📅'">
                                View Weekly Calendar
                            </a>
                            &nbsp;

                            <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                               title="Edit Topic">
                                ✎
                            </a>

                            <!--
                        <div class="crop-text" style="width: 100%; text-align: right; color: gray;">
                            <a th:href="@{/categories/edit/{id}(id=${topic.category.id}, returnPage= 'topics')}"
                               th:text="${topic.category.name}">
                                Edit Category Name
                            </a>
                        </div>
                            -->
                            &nbsp;

                        </td>


                    </tr>
                    </tbody>
                </table>
            </div>

        </div>


        <!-- Modal yapısı weekly entry calendar icin -->
        <div id="modal" class="modal text-center" style="display:none;background-color:rgba(0, 0, 0, 0.5);">
            <button onclick="document.getElementById('modal').style.display='none'"
                    style="background-color:WhiteSmoke;"
            >Close</button>
            <div class="modal-content" id="modal-content">
                <!-- İçerik buraya yüklenecek -->
            </div>
        </div>


        <!-- asagida jquery nin bulunabilmesi ve web gezgini konsolunda hata vermemesi icin maalesef versiyonu da yazdik
        cunku zannedersem webjar locator kutuphanesi bunu versiyonsuz bulamiyor.
        WebJars path'leri şu yapıyı izler:
        /webjars/{artifactId}/{version}/{dosya}
        -->
        <script type="text/javascript" th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>

        <script type="text/javascript" th:src="@{/webjars/bootstrap/5.3.7/js/bootstrap.min.js}"></script>

        <script type="text/javascript" th:src="@{/webjars/datatables/2.3.0/js/dataTables.js}"></script>

        <!-- https://datatables.net/plug-ins/sorting/turkish-string -->
        <script src="https://cdn.datatables.net/plug-ins/2.3.2/sorting/turkish-string.js"></script>


        <!-- <script type="text/javascript" th:src="@{/webjars/datatables/2.3.0/js/dataTables.bootstrap5.min.js}"></script> -->
        <script type="text/javascript" th:src="@{/webjars/htmx.org/dist/htmx.min.js}"></script>

        <!-- chart -->
        <script type="text/javascript" th:src="@{/webjars/chart.js/4.5.0/dist/chart.umd.js}"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script> -->
        <script th:src="@{/js/chartjs-plugin-annotation.js}"></script>
        <!-- https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js -->
        <script th:src="@{/js/chartjs-adapter-date-fns.bundle.min.js}"></script>

        <!-- Modal yapısı weekly entry calendar icin -->
        <script>
            // Modal disina tıklaninca da modali kapatmak icin bu script gerekli cunku kutuphaneli bir modal kullanmadik.
            document.getElementById('modal').addEventListener('click', function (event) {
                const modalContent = document.getElementById('modal-content');
                if (!modalContent.contains(event.target)) {
                    this.style.display = 'none';
                }
            });
        </script>

        <script>

            $(document).ready( function () {
                let table = new DataTable('#topicsTable', {
                    pageLength: 50
                });

            });
        </script>

        <script th:inline="javascript">
            function onCategoryChange() {
                var categoryId = document.getElementById("categorySelect").value;
                var baseUrl = /*[[ @{/topics} ]]*/;  // Bu satır, server tarafında /topics olarak parse edilecek

                if (categoryId === "") {
                    window.location.href = baseUrl;
                } else {
                    window.location.href = baseUrl + "?categoryId=" + categoryId;
                }
            }
        </script>

        <!-- 3️⃣ Filtreleme için JS -->
        <script>
            (function(){
              const filterInput = document.getElementById('categoryTextFilter');
              const selectEl    = document.getElementById('categorySelect');

              // 1️⃣ Orijinal kategori seçeneklerini (dummy hariç) saklıyoruz
              const dummyOption = { value: '-1', text: 'All' };
              const categoryOptions = Array.from(selectEl.options)
                  .filter(opt => opt.value !== '-1') // All hariç gerçek kategoriler
                  .map(opt => ({
                      value: opt.value,
                      text: opt.dataset.fulltext || opt.text
                    }));


                filterInput.addEventListener('input', function(){
                const term = this.value.trim().toLowerCase();

                // 2️⃣ Select'i temizle
                selectEl.innerHTML = '';

                // 3️⃣ En başa hep dummy seçeneğini ekle
                selectEl.add(new Option(dummyOption.text, dummyOption.value));

                // 4️⃣ Sonra, arama terimine uyan gerçek kategorileri ekle
                categoryOptions
                  .filter(({ text }) => term === '' || text.toLowerCase().includes(term))
                  .forEach(({ text, value }) => {
                    const opt = new Option(text, value);
                    opt.dataset.fulltext = text;
                    opt.title = text;
                    selectEl.add(opt);
                  });
              });
            })();
        </script>

        <script th:inline="javascript">
            function onCategoryChange() {
              var selectEl = document.getElementById("categorySelect");
              var categoryId = selectEl.value;
              var baseUrl = /*[[@{/topics}]]*/ '/topics';

              // -1 gelirse controller 'All' olarak işliyor; isterseniz baseUrl (param yok) de gönderebilirsiniz.
              window.location.href = baseUrl + "?categoryId=" + encodeURIComponent(categoryId);
            }
        </script>



    </body>
</html>
