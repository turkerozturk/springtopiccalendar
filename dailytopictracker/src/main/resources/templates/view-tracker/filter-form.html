<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:hx="http://www.w3.org/1999/xhtml">
<head>
    <!--
    This file is part of the DailyTopicTracker project.
    Please refer to the project's README.md file for additional details.
    https://github.com/turkerozturk/springtopiccalendar
    -->
    <title>Entry Filter and Pivot Table</title>

    <!-- meta -->
    <meta charset="UTF-8">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">

     <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/css/all.min.css}">

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap-datepicker/dist/css/bootstrap-datepicker.css}">


    <style>








        /* https://stackoverflow.com/questions/3203252/unicode-character-as-bullet-for-list-item-in-css */
        ul li {
          list-style: none;
          padding: 0px;
        }
        ul li:before {
          content: "\2606";
          margin: 0 1em;    /* any design */
        }

        .fonbg {
            background: linear-gradient(90deg, rgba(203, 231, 242, 0.50) 0%, rgba(203, 242, 206, 1) 33%, rgba(242, 209, 203, 1) 66%, rgba(209, 209, 209, 0.50) 100%);
        }

        body {
      margin: 0px;
  }

  #navigation-panel button, a{
    border-radius:10px !important;
  }

 #navigation-panel {
     max-width: 640px;
     margin-top: 10px;
     margin-bottom: 5px;
     margin-left: auto;
     margin-right: auto;
     padding: 3px;
     border: 2px solid DarKGray;
     border-radius: 7px 7px 7px 7px;

     /* https://cssgradient.io/ */

     background: #a7d6e8;
     background: linear-gradient(90deg, rgba(203, 231, 242, 0.50) 0%, rgba(203, 242, 206, 1) 33%, rgba(242, 209, 203, 1) 66%, rgba(209, 209, 209, 0.50) 100%);
  }


#header-next-prediction {
background: linear-gradient(180deg, LightBlue 0%, rgba(255, 255, 255, 1) 20%);
}

#header-last-done {
background: linear-gradient(180deg, palegreen 0%, rgba(255, 255, 255, 1) 20%);
}

#header-first-warn {
background: linear-gradient(180deg, Tomato 0%, rgba(255, 255, 255, 1) 20%);
}

#header-upcoming-note {
background: linear-gradient(180deg, gainsboro 0%, rgba(255, 255, 255, 1) 20%);
}





.last-done {
background: radial-gradient(circle, palegreen 30%, rgba(255, 255, 255, 1) 100%);
}

.first-warn {
background: radial-gradient(circle, Tomato 30%, rgba(255, 255, 255, 1) 100%);
}

.upcoming-note {
background: #CDD3CE;
background: radial-gradient(circle, gainsboro 30%, rgba(255, 255, 255, 1) 100%);
}



  #pivot-table {
     background-color: WhiteSmoke;
     border: 3px solid black;

  }



/* https://css-pattern.com/cubes-illusion/ */
 body {
  --s: 210px; /* control the size*/
  --c1: #1d1d1d;
  --c2: #4e4f51;
  --c3: #3c3c3c;

  background:
    repeating-conic-gradient(from 30deg,#0000 0 120deg,var(--c3) 0 50%)
     calc(var(--s)/2) calc(var(--s)*tan(30deg)/2),
    repeating-conic-gradient(from 30deg,var(--c1) 0 60deg,var(--c2) 0 120deg,var(--c3) 0 50%);
  background-size: var(--s) calc(var(--s)*tan(30deg));
}
          .entry-with-content {
              color: blue !important;
              font-weight:bold;
          }


          #topic-name {
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            max-width: 200px;
          }

          #category-name {
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            max-width: 100px;
          }


          .highlighted-day {
              background-color: yellow; /* Örnek */
              font-weight: bold;
          }

            /* Haftanın geri kalan günü için */
            .highlighted-week {
              background-color: #e2f0d9; /* örnek yeşil */
            }


                        a {
                    text-decoration: none;
                    color: inherit;
                    }

                    a:visited {
                        color: inherit;
                    }

                    a:hover {
                        color: blue;
                    }

                .centered {
                max-width: fit-content;
                  margin-left: auto;
                  margin-right: auto;
                  }

                .highlighted {
                background-color: FloralWhite !important;
                }
                .pivot-table-entry-cell {
                    text-align: center;      /* yatay ortalama */
                    vertical-align: middle;  /* dikey ortalama */
                    min-width: 20px;
                    min-height: 20px;

                    max-width: 20px;         /* Maksimum genişlik  */
                    max-height: 20px;         /* Maksimum genişlik  */

                    width: 20px;             /* Sabit genişlik  */
                    height: 20px;
                    padding: 0px;

                    background-color: WhiteSmoke;

                }

                .pivot-table-entry-cell a {
                text-decoration: none;   /* alt çizgiyi kaldır */
                color: inherit;          /* bulunduğu hücrenin rengini kullan */
                    padding: 0px;

                }

                .pivot-table-entry-cell a:visited {
                    color: inherit;          /* tıklanmış linkin rengini değiştirme */
                }

                 caption {
                    color: WhiteSmoke !important;
                }

                a.add-new-entry {
                  color: transparent;
                  transition: color 0.3s ease;

                  min-width: 20px;
                  min-height: 20px;

                  max-width: 20px;         /* Maksimum genişlik  */
                  max-height: 20px;         /* Maksimum genişlik  */

                  width: 20px;             /* Sabit genişlik  */
                  height: 20px;
                  padding: 0px;
                }

                a.add-new-entry:hover {
                  color: black;
                  background-color:honeydew;
                  font-size: 16px;
                  font-weight: bold;

                  min-width: 20px;
                  min-height: 20px;

                  max-width: 20px;         /* Maksimum genişlik  */
                  max-height: 20px;         /* Maksimum genişlik  */

                  width: 20px;             /* Sabit genişlik  */
                  height: 20px;
                  padding: 0px;
                }

                .pivot-table-entry-header {

                    text-align: center;
                    font-family: "Courier", Courier, monospace;
                }

                .vertical-text {
                    writing-mode: vertical-rl; /* dikey yazım yönü: sağdan sola yukarı */
                    transform: rotate(180deg); /* metni yukarı çevirmek için 180 derece çevir */
                    vertical-align: middle;
                    padding: 0px;
                    margin: 0px;
                    white-space: nowrap;

                    max-width: 20px;
                    width: 20px;

                }

                .status-0 {
                    background-color: gainsboro !important;
                }
                .status-1 {
                    background-color: palegreen !important;
                }
                .status-2 {
                    background-color: tomato !important;
                }
                .status-3 {
                    background-color: LightBlue !important;
                }
                .status-4 {
                    background-color: WhiteSmoke !important;
                }
                .status-5 {
                    background-color: LightSteelBlue !important;
                }

                /* gelecekte yeni status değerleri eklemek kolaylaşır */

                        .accordion-container {
                          max-width: 400px;
                          margin: 0 auto; /* Ortalansın diye */
                        }

                        .align-center-horizontal {
                          /* max-width: 400px; */
                          margin: 0 auto; /* Ortalansın diye */
                        }


     /* offcanvasdaki topic listesi iceren tablo asagi dogru cok uzamasin diye scrollbar gosterir gerektiginde. */
    .scrollable-topics-table {
      max-height: 600px;      /* ~20 satırlık yükseklik, ihtiyaca göre ayarlayın */
      overflow-y: auto;       /* dikey kaydırma */
      /* isterseniz yatay kaydırma da istemiyorsanız overflow-x: hidden; ekleyin */
    }

    </style>
</head>
<body>


<div  id="navigation-panel">


    <div th:replace="~{fragments/fragnavigation :: fragnavigation}"></div>

    <div style="margin-top:4px;">




    <!-- Önceki & Sonraki & Temizle -->
    <form th:action="@{/entry-filter/previous}" th:object="${filterDto}" method="post" style="display:inline;">
        <!-- Gizli alanlar -->
        <input type="hidden" th:field="*{topicIds}"/>
        <input type="hidden" th:field="*{startDate}"/>
        <input type="hidden" th:field="*{endDate}"/>
        <input type="hidden" th:field="*{statuses}"/>
        <input type="hidden" th:field="*{categoryId}"/>
        <input type="hidden" th:field="*{entriesThreshold}" />

        <button type="submit" title="Previous Date Range" class="btn btn-secondary btn-sm">◀️date</button>
    </form>



    <form th:action="@{/entry-filter/next}" th:object="${filterDto}" method="post" style="display:inline;">
        <!-- Gizli alanlar -->
        <input type="hidden" th:field="*{topicIds}"/>
        <input type="hidden" th:field="*{startDate}"/>
        <input type="hidden" th:field="*{endDate}"/>
        <input type="hidden" th:field="*{statuses}"/>
        <input type="hidden" th:field="*{categoryId}"/>
        <input type="hidden" th:field="*{entriesThreshold}" />

        <button type="submit" title="Next Date Range" class="btn btn-secondary btn-sm">date▶️</button>
    </form>

    <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasTop"
            aria-controls="offcanvasTop">Toggle Filter</button>

        <th:block th:if="${selectedCategory != null && selectedCategory.archived}">
            [Category navigation is disabled.]
        </th:block>
        <th:block th:if="${selectedCategory != null && !selectedCategory.archived}">

            <!-- filter-form içinde, categorySelect’in hemen yanına ya da uygun bir yere ekleyin -->
            <form th:action="@{/entry-filter/previousCategory}" th:object="${filterDto}"
                  method="post" style="display:inline;">
                <!-- mevcut filterDto alanlarının tamamı gizli alan olarak gönderilmeli -->
                <input type="hidden" th:field="*{topicIds}" />
                <input type="hidden" th:field="*{startDate}" />
                <input type="hidden" th:field="*{endDate}" />
                <input type="hidden" th:field="*{statuses}" />
                <input type="hidden" th:field="*{categoryId}" />
                <input type="hidden" th:field="*{entriesThreshold}" />

                <button type="submit" class="btn btn-sm btn-secondary" title="Previous Category">
                    ◀️category
                </button>
            </form>


            <form th:action="@{/entry-filter/nextCategory}" th:object="${filterDto}"
                  method="post" style="display:inline; margin-left:4px;">
                <input type="hidden" th:field="*{topicIds}" />
                <input type="hidden" th:field="*{startDate}" />
                <input type="hidden" th:field="*{endDate}" />
                <input type="hidden" th:field="*{statuses}" />
                <input type="hidden" th:field="*{categoryId}" />
                <input type="hidden" th:field="*{entriesThreshold}" />

                <button type="submit" class="btn btn-sm btn-secondary" title="Next Category">
                    category▶️
                </button>
            </form>

        </th:block>
</div>


</div> <!-- end div of background css pattern -->





<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasTop" aria-labelledby="offcanvasTopLabel">
    <div class="offcanvas-header">
        <h5 id="offcanvasTopLabel">Filter</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
<!-- <h1>Entry Filtre Formu</h1> -->

<!-- Validasyon hataları -->
<!-- TODO
<div th:if="${#fields.hasErrors('*')}">
    <p style="color:red" th:each="err : ${#fields.errors('*')}" th:text="${err}"></p>
</div>
-->


            <h2 >


                    Filter Criteria
            </h2>

            <div
                 >
                <div >

                    <!-- Form Başlangıcı -->
                    <form th:action="@{/entry-filter/apply}" th:object="${filterDto}" method="post">

                        <!-- 1️⃣ Filtre Kutusu -->
                        <div class="row mb-3">
                            <label for="categoryTextFilter" class="col-sm-4 col-form-label">Category Filter:</label>
                            <div class="col-sm-8">
                                <input type="text"
                                       id="categoryTextFilter"
                                       class="form-control"
                                       placeholder="Category Containing..">
                            </div>
                        </div>

                        <!-- 2️⃣ Kategori Seçimi -->
                        <div class="row mb-3">
                            <label for="categorySelect" class="col-sm-4 col-form-label">Category:</label>
                            <div class="col-sm-8">
                                <select id="categorySelect"
                                        class="form-select"
                                        th:field="*{categoryId}"
                                        onchange="onCategoryChange(this.value)">
                                    <option value="">--Select--</option>
                                    <option th:each="cat : ${allCategories}"
                                            th:value="${cat.id}"
                                            th:text="${cat.name}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Topic Çoklu Seçimi -->
                        <div class="row mb-3">
                            <label for="topicsSelect" class="col-sm-4 col-form-label">
                                Topic (multi):
                            </label>
                            <div class="col-sm-8">
                                <select id="topicsSelect"
                                        class="form-select"
                                        th:field="*{topicIds}"
                                        multiple
                                        size="5">
                                    <option th:each="t : ${topicsForSelectedCategory}"
                                            th:value="${t.id}"
                                            th:text="${t.name}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Tarih Aralığı: Başlangıç Tarihi -->
                        <div class="row mb-3" id="startDateContainer">
                            <div class="input-group startDateStyle date">
                                <label for="startDate" class="col-sm-4 col-form-label">
                                    Start Date:
                                </label>
                                <input type="text" id="startDate"
                                       class="col-sm-8 form-control"
                                       th:field="*{startDate}"
                                />
                                <span class="input-group-append">
                                         <button class="btn btn-outline-secondary" type="button">
                                             <!-- https://www.w3schools.com/icons/fontawesome5_icons_datetime.asp -->
                                             <i class="far fa-calendar" aria-hidden="true"></i>
                                         </button>
                                </span>
                            </div>
                        </div>

                        <!-- Tarih Aralığı: Bitiş Tarihi -->
                        <div class="row mb-3" id="endDateContainer">
                            <div class="input-group endDateStyle date">
                                <label for="endDate" class="col-sm-4 col-form-label">
                                    End Date:
                                </label>
                                <input type="text" id="endDate"
                                       class="col-sm-8 form-control"
                                       th:field="*{endDate}"
                                />
                                <span class="input-group-append">
                                         <button class="btn btn-outline-secondary" type="button">
                                             <i class="far fa-calendar" aria-hidden="true"></i>
                                         </button>
                                </span>
                            </div>
                        </div>

                        <!-- Status Çoklu -->
                        <div class="row mb-3">
                            <label for="statuses" class="col-sm-4 col-form-label">
                                Status (multi):
                            </label>
                            <div class="col-sm-8">
                                <select class="form-select"
                                        id="statuses"
                                        th:field="*{statuses}"
                                        multiple
                                        size="3">
                                    <option value="0">Not Marked (0)</option>
                                    <option value="1">Done (1)</option>
                                    <option value="2">Warning (2)</option>
                                </select>
                            </div>
                        </div>


                        <!-- 6️⃣ Entries Threshold -->
                        <div class="row mb-3">
                            <label for="entriesThreshold" class="col-sm-4 col-form-label">
                                Entries Threshold:
                            </label>
                            <div class="col-sm-8">
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="decrementThreshold()">
                                        &minus;
                                    </button>
                                    <!-- binds to FilterDto.entriesThreshold -->
                                    <input type="number"
                                           id="entriesThreshold"
                                           class="form-control text-center"
                                           th:field="*{entriesThreshold}"
                                           min="0"
                                           placeholder="0"/>
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="incrementThreshold()">
                                        &#43;
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Current threshold:
                                    <span id="thresholdValue"
                                          th:text="${filterDto.entriesThreshold} ?: 0">
                                        0
                                    </span>
                                </small>
                            </div>
                        </div>






                        <!-- Filtrele Butonu -->
                        <div class="row mb-3">
                            <div class="col-sm-12 text-center">
                                <button type="submit" class="btn btn-primary">
                                    Apply Filter
                                </button>
                            </div>
                        </div>
                    </form>
                    <!-- Form Bitişi -->

                </div>
            </div>


<div class="align-center-horizontal">



    <form th:action="@{/entry-filter/clear}" method="post" style="display:inline;">
        <button type="submit">Reset Filter</button>
    </form>

</div>

<hr/>

<!-- Seçili Kategori'ye ait tüm topicler için new entry ekleme linklerin basılacağı placeholder, js bağlantılı  -->
<div id="newEntryLinksContainer" style="margin-top: 10px; max-width:800px; background-color:honeydew;"  class="centered">
    When you select a category from the category filter, the entry adding links will appear here.
</div>

    </div></div>

<!-- Filtre Sonuçları -->


<!-- Pivot tablo -->

<th:block th:if="${filterDto.categoryId == null}" >

    <div class="alert alert-success centered">
        <h1><span class="fonbg">Tracker</span></h1>
        <ul>
            <li>You can use the <b>◀️category▶️</b> navigation buttons to view the tables.</li>
            <li>Or select a category from filter. To see the filter interface, click <b>Toggle Filter</b> button.</li>
        <li>Or select a category from the <b>Category Groups</b> page.</li>
        <li>If you haven't created any categories yet, create one from the <b>Categories</b> page first. Then add a few <b>Topics</b>.</li>
        </ul>
    </div>
    <br />

</th:block>

<div th:if="${filterDto.categoryId != null}" class="centered">

    <!-- Tabloyu sarmalayan scrollable container -->
    <div style="overflow-x: auto; max-width: 100%;">

    <table id="pivot-table" class="table-bordered table-sm caption-top">
        <caption>
            Pivot Table

            <th:block th:if="${selectedCategory != null && !selectedCategory.archived}">

                <!-- iterate with status -->
                <span th:each="cat, iStats : ${allCategories}"
                      th:if="${cat.id} == ${filterDto.categoryId}">

                <!-- your existing link -->
                <a th:text="${'-&nbsp;' + cat.name}"
                   th:title="${'Click to rename'}"
                   th:href="@{/categories/edit/{id}(id=${cat.id}, returnPage= 'pivottable')}">
                </a>

                            <!-- position / total -->
                <span class="ms-2"
                      th:text=" '(' + ${iStats.count} + ' / ' + ${allCategories.size() + ')' }">
                  <!-- e.g. “3 / 10” -->
                </span>
              </span>

            </th:block>


            <th:block th:if="${selectedCategory != null && selectedCategory.archived}">
                <a th:text="${'-&nbsp;' + selectedCategory.name}"
                   th:title="${'Click to rename'}"
                   th:href="@{/categories/edit/{id}(id=${selectedCategory.id}, returnPage= 'pivottable')}">
                </a>
                <span> &nbsp;[An archived category does not have previous and next category navigation buttons.]</span>
            </th:block>

        </caption>


        <!-- Tablonun başlığı (thead) -->
        <thead>
        <tr>

            <!-- ilk sütun Topic başlığı (sütun sırasını değiştirme veya scriptin bozulmaması için orayı güncelle) -->
            <th>
                <!-- Tıklayınca sıralama yapsın -->
                <span onclick="sortPivotTableByColumn(0)" style="cursor: pointer;">Topic</span>

                <!-- HTMX ayarları -->

                <!-- 1) Offcanvas’ı tetikleyecek düğme -->
                <button
                        th:if="${filterDto.categoryId != null}"
                class="btn btn-primary"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#topicsOffcanvas"
                aria-controls="topicsOffcanvas"
                th:attr="hx-get=@{/entry-filter/fragment-topics-by-category(categoryId=${filterDto.categoryId})}"
                hx-target="#topicsOffcanvasBody"
                hx-trigger="click"
                title="Add Topic For This Category">
                +
                </button>


                <!-- Altına veya yanına bir arama kutusu koyuyoruz -->
                <div>
                    <input type="text"
                           id="topicSearchBox"
                           placeholder="Search Topic..."
                           onkeyup="filterPivotTable()"
                           style="width: 100px;"/>
                </div>
            </th>

            <!-- kondisyonal sütun: category sütunu sadece tek bir kategori seçilmediğinde görünsün -->
            <th th:if="${filterDto.categoryId == null}">

                <span onclick="sortPivotTableByColumn(1)" style="cursor: pointer;">Category</span>


                <!-- Altına veya yanına bir arama kutusu koyuyoruz -->
                <div>
                    <input type="text"
                           id="categorySearchBox"
                           placeholder="Search Category..."
                           onkeyup="filterPivotTable()"
                           style="width: 100px;"/>
                </div>
            </th>

            <!-- Tarih sütun başlıkları, uygulama acilisinda application.properties'den okunan iki ayri date format ile birlikte -->
            <th:block th:each="day : ${pivotData.dateRange}">
                <td th:if="${day.equals(today)}"
                class="pivot-table-entry-header highlighted-day">

                <span th:text="${#temporals.format(day, dateFormat)}"
                      class="vertical-text"
                      th:title="${#temporals.format(day, dateFormatTitle)}">
                    Gün
                </span>
                </td>

                <td  th:if="${not day.equals(today)}"
                     th:classappend="
                    ${#temporals.dayOfWeek(day) >= 1 && #temporals.dayOfWeek(day) <= 7 &&
                     day.isAfter( startOfWeek.minusDays(1) ) &&
                     day.isBefore(startOfWeek.plusDays(7))} ? 'highlighted-week' : ''"
                    class="pivot-table-entry-header">

                <span th:text="${#temporals.format(day, dateFormat)}"
                      class="vertical-text"
                      th:title="${#temporals.format(day, dateFormatTitle)}">
                    Gün
                </span>
                </td>
            </th:block>


            <th class="text-center" style="vertical-align: middle;">Visible<br />Done<br />Count<br /></th>

            <th class="text-center" style="vertical-align: middle;">Visible<br />Row<br />Num</th>

            <th class="text-center status-3"
                id="header-next-prediction"
                style="vertical-align: middle;" title="Prediction">Next<br />Pre<br />dic<br />tion<br />(day)</th>

            <th class="text-center" style="vertical-align: middle;" title="Pinned">📌</th>

            <th class="text-center status-1" style="vertical-align: middle;"
                id="header-last-done"
                title="Last Past Done Entry Date: Shows the day count and the date(hover mouse) of the 'done(green colored)' entry closest to the current day in the past.">Last<br />Done<br />(day)</th>

            <th class="text-center status-2"
                id="header-first-warn"
                style="vertical-align: middle;" title="First Warning Entry Date: Shows the day count and the date(hover mouse) of the 'warn(red colored)' entry amongst all entries for a topic. It is a negative number if it is in the past. ">First<br />Warn<br />(day)</th>

            <th class="text-center status-0"
                id="header-upcoming-note"
                style="vertical-align: middle;" title="First Future Neutral Entry Date: Shows the day count and the date(hover mouse) of the 'not marked(gray colored)' entry closest to the current day in the future.">Upco<br />ming<br />Note<br />(day)</th>

            <th class="text-center" style="vertical-align: middle;" title="Weekly Calendar View">📅</th>

        </tr>
        </thead>

        <tbody>



        <!-- Eger en az bir topic varsa -->
        <!-- Her topic için bir satır -->
        <tr th:each="topic, iStat : ${pivotData.topicList}">

            <!-- ilk sütun Topic adı (sütun sırasını değiştirme veya scriptin bozulmaması için orayı güncelle) -->
            <td id="topic-name">
                <a th:href="@{/entries(topicId=${topic.id})}"
                   th:text="${topic.name}" th:title="${topic.name + (!#strings.isEmpty(topic.description) ? ': ' + topic.description : '')}">
                </a>
            </td>

            <!-- kondisyonal sütun: category sütunu sadece tek bir kategori seçilmediğinde görünsün -->
            <td id="category-name" th:if="${filterDto.categoryId == null}" th:text="${topic.category.name}"></td>

            <!-- Ardından pivotData.dateRange kadar hücre -->
            <!-- pivotData.dateRange kadar hücre -->

            <th:block th:each="day : ${pivotData.dateRange}"
                      th:with="entriesForDay=${pivotData.pivotMap[topic.id].get(day)}">

                <!-- 1) Var olan (status!=3) entry’leri link şeklinde göster -->
                <th:block th:if="${entriesForDay != null}">
                    <td th:each="entryItem : ${entriesForDay}"
                        th:if="${entryItem.status != 3}"
                        th:class="'pivot-table-entry-cell status-' + ${entryItem.status}">

                        <a th:href="@{/entries/edit/{id}(id=${entryItem.id},
                                           categoryId=${topic.category.id},
                                           returnPage=pivottable)}">

                            <th:block th:if="${not #strings.isEmpty(entryItem.note.content)}">
                    <span th:title="${entryItem.note.content}"
                          class="entry-with-content">
                        @
                    </span>
                            </th:block>
                            <th:block th:if="${#strings.isEmpty(entryItem.note.content)}">
                    <span th:title="${'Entry ' + entryItem.id}">
                        @
                    </span>
                            </th:block>
                        </a>
                        <br/>
                    </td>
                </th:block>

                <!-- 2a) Eğer hiç entry yoksa 'New Entry' linki göster -->
                <th:block th:if="${entriesForDay == null or #lists.isEmpty(entriesForDay)}">
                    <td class="pivot-table-entry-cell">
                        <a th:href="@{/entries/new(topicId=${topic.id},
                                       dateYmd=${day},
                                       categoryId=${topic.category.id},
                                       returnPage=pivottable)}"
                           title="Add New Entry"
                           class="add-new-entry">+</a>
                    </td>
                </th:block>

                <!-- 2b) Eğer o güne yalnızca synthetic entry (status==3) eklenmişse -->
                <th:block th:if="${entriesForDay != null
                     and !#lists.isEmpty(entriesForDay.?[status == 3])}">
                    <td th:class="'pivot-table-entry-cell status-3'">
                        <a th:href="@{/entries/new(topicId=${topic.id},
                                       dateYmd=${day},
                                       categoryId=${topic.category.id},
                                       returnPage=pivottable)}"
                           title="Add New Entry"
                           class="add-new-entry">+</a>
                    </td>
                </th:block>

            </th:block>


            <!-- turker topic'in toplam görünen "done" entry sayısı -->
            <td class="text-center">
                <span th:text="${pivotData.status1Counts[topic.id]} ?: 0">0</span>
            </td>

            <!-- thymeleaf in satir no indeksi ozelligi(sifirdan baslar)-->
            <td th:text="${iStat.index + 1}" class="text-center"></td>




             <!-- predictionDate varsa -->
            <th:block th:if="${topic.predictionDate != null or !#strings.isEmpty(topic.predictionDate)}">

                <!-- predictionDate dateRange içinde yoksa -->
                <th:block th:if="${not #lists.contains(pivotData.dateRange, topic.predictionDate)}"
                >

                    <!-- Eğer topic.predictionDate dateRange'deki en küçük tarihten küçükse -->
                    <th:block th:if="${topic.predictionDate.isBefore(pivotData.dateRange[0])}">
                        <!-- Örneğin: başlangıç tarihinden önceki durum için buraya içerik ekleyin -->
                        <td th:title="${T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.predictionDate.atStartOfDay(zoneId))
                                      + ' (every ' + topic.someTimeLater + ' days)'}"
                            class="status-3" style="text-align: center">
                            <a th:href="@{/topics/edit/{id}(id=${topic.id})}">🔥🔥️</a>
                        </td>
                    </th:block>

                    <!-- Eğer topic.predictionDate dateRange'deki en büyük tarihten büyükse -->
                    <th:block th:if="${topic.predictionDate.isAfter(pivotData.dateRange[pivotData.dateRange.size() - 1])}">
                        <!-- Örneğin: bitiş tarihinden sonraki durum için buraya içerik ekleyin -->
                        <td th:title="${T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.predictionDate.atStartOfDay(zoneId)) + ' (every ' + topic.someTimeLater + ' days)'}" class="status-3" style="text-align: center">
                            <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                               style="">💧💧</a>
                        </td>
                    </th:block>

                </th:block>

                <!-- predictionDate dateRange içinde varsa -->
                <th:block th:if="${#lists.contains(pivotData.dateRange, topic.predictionDate)}"
                >
                    <!-- topic.predictionDate today'e eşitse -->
                    <th:block th:if="${topic.predictionDate.equals(today)}">
                        <!-- Bugünün tarihine denk gelen durum için buraya içerik ekleyin -->
                        <td th:title="${T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.predictionDate.atStartOfDay(zoneId)) + ' (every ' + topic.someTimeLater + ' days)'}"  class="status-5" style="text-align: center">
                            <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                               style="">🔔</a>
                        </td>
                    </th:block>

                    <!-- topic.predictionDate today'e eşit değilse -->
                    <th:block th:if="${!topic.predictionDate.equals(today)}">
                        <!-- DateRange içinde ama bugünden farklı tarih için buraya içerik ekleyin -->

                        <!-- topic.predictionDate bugün’den küçükse -->
                        <th:block th:if="${topic.predictionDate.isBefore(today)}">
                            <td th:title="${T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.predictionDate.atStartOfDay(zoneId)) + ' (every ' + topic.someTimeLater + ' days)'}"
                                class="status-5"
                                style="text-align: center">
                                <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                                   style="">🔥</a>
                            </td>
                        </th:block>

                        <!-- topic.predictionDate bugün’den büyükse -->
                        <th:block th:if="${topic.predictionDate.isAfter(today)}">
                            <td th:title="${T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.predictionDate.atStartOfDay(zoneId)) + ' (every ' + topic.someTimeLater + ' days)'}"
                                class="status-5"
                                style="text-align: center">
                                <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                                   style="">💧</a>
                            </td>
                        </th:block>



                    </th:block>

                </th:block>


            </th:block>


            <!-- predictionDate yoksa -->
            <th:block th:if="${topic.predictionDate == null or #strings.isEmpty(topic.predictionDate)}"
            >
                <td title="You can manually add the next date prediction on topic settings." style="text-align: center">
                    <a th:href="@{/topics/edit/{id}(id=${topic.id})}"
                       style="">ℹ️</a>
                </td>
            </th:block>


            <td class="text-center">
                <span th:text="${topic.pinned} ? '📌' : '&nbsp;'"></span>
            </td>

            <!-- lastPastEntryDate varsa -->
            <th:block th:if="${topic.lastPastEntryDate != null or !#strings.isEmpty(topic.lastPastEntryDate)}">
                <td th:title="${'Last done: '
                                        + T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.lastPastEntryDate.atStartOfDay(zoneId))
                                        + ' ('
                                        +  T(java.time.temporal.ChronoUnit)
                            .DAYS.between(topic.lastPastEntryDate, T(java.time.LocalDate).now(zoneId))
                                        + ' days before)' }"
                    class="last-done"
                    style="text-align: center">

                    <!-- how many days has past until today -->
                    <span th:text="${T(java.time.temporal.ChronoUnit)
                            .DAYS.between(T(java.time.LocalDate).now(zoneId), topic.lastPastEntryDate)}">
                    </span>
                </td>
            </th:block>

            <!-- lastPastEntryDate yoksa -->
            <th:block th:if="${topic.lastPastEntryDate == null or #strings.isEmpty(topic.lastPastEntryDate)}"
            >
                <td title="At least one entry with the status 'done(green colored)' closest to the current day in the past is required." style="text-align: center">
                    &nbsp;
                </td>
            </th:block>



            <!-- firstWarningEntryDate varsa -->
            <th:block th:if="${topic.firstWarningEntryDate != null or !#strings.isEmpty(topic.firstWarningEntryDate)}">
                <td th:title="${'First warn: '
                                        + T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.firstWarningEntryDate.atStartOfDay(zoneId))
                                        + ' ('
                                        +  T(java.time.temporal.ChronoUnit)
                            .DAYS.between( T(java.time.LocalDate).now(zoneId), topic.firstWarningEntryDate )
                                        + ' days)' }"
                    class="first-warn"
                    style="text-align: center">

                    <!-- how many days has past until today -->
                    <span th:text="${T(java.time.temporal.ChronoUnit)
                            .DAYS.between( T(java.time.LocalDate).now(zoneId), topic.firstWarningEntryDate ) }">
                    </span>
                </td>
            </th:block>

            <!-- firstWarningEntryDate yoksa -->
            <th:block th:if="${topic.firstWarningEntryDate == null or #strings.isEmpty(topic.firstWarningEntryDate)}"
            >
                <td title="At least one entry with the status 'warning(red colored)' is required." style="text-align: center">
                    &nbsp;
                </td>
            </th:block>

            <!-- firsFutureNeutralEntryDate varsa -->
            <th:block th:if="${topic.firstFutureNeutralEntryDate != null or !#strings.isEmpty(topic.firstFutureNeutralEntryDate)}">
                <td th:title="${'Upcoming in: '
                                        + T(java.time.format.DateTimeFormatter)
                                        .ofPattern('yyyy-MM-dd')
                                        .format(topic.firstFutureNeutralEntryDate.atStartOfDay(zoneId))
                                        + ' ('
                                        +  T(java.time.temporal.ChronoUnit)
                            .DAYS.between( T(java.time.LocalDate).now(zoneId), topic.firstFutureNeutralEntryDate )
                                        + ' days)' }"
                    class="upcoming-note"
                    style="text-align: center">

                    <!-- how many days has past until today -->
                    <span th:text="${T(java.time.temporal.ChronoUnit)
                            .DAYS.between( T(java.time.LocalDate).now(zoneId), topic.firstFutureNeutralEntryDate ) }">
                    </span>
                </td>
            </th:block>

            <!-- firsFutureNeutralEntryDate yoksa -->
            <th:block th:if="${topic.firstFutureNeutralEntryDate == null or #strings.isEmpty(topic.firstFutureNeutralEntryDate)}"
            >
                <td title="At least one entry with the status 'not marked(gray colored)' in the future is required." style="text-align: center">
                    &nbsp;
                </td>
            </th:block>

            <td>

                <a
                        th:href="@{/entries/weekly-calendar?topicId={id}(id=${topic.id})}"
                        th:attr="hx-get=@{/entries/weekly-calendar?topicId={id}(id=${topic.id})}"
                        hx-target="#modal-content"
                        hx-trigger="click"
                        hx-swap="innerHTML"
                        onclick="document.getElementById('modal').style.display='block'; return false;"
                        th:text="'📅'">
                    View Weekly Calendar
                </a>
            </td>


        </tr>


        </tbody>
    </table>

        <!-- Eger hic topic yoksa bilgilendirici mesaj goster-->
        <th:block th:if="${pivotData.topicList == null or #lists.isEmpty(pivotData.topicList)}">
            <br />
            <div class="alert alert-success centered">
                <p>Add topics to this category.</p>
                <p>To view the newly added topics, navigate to another category and return back.</p>
                <p>Rrefreshing the page does not work for newly added topics.</p>
            </div>
            <br />
        </th:block>



    </div>
</div>

<!-- Modal yapısı weekly entry calendar icin -->
<div id="modal" class="modal text-center" style="display:none;background-color:rgba(0, 0, 0, 0.5);">
    <button onclick="document.getElementById('modal').style.display='none'"
            style="background-color:WhiteSmoke;"
    >Close</button>
    <div class="modal-content" id="modal-content">
        <!-- İçerik buraya yüklenecek -->
    </div>
</div>



<!-- Düz liste tablo -->

<div th:if="${entries != null}" class="align-center-horizontal">
    <h2>Results</h2>
    <table class="table table-bordered table-sm">
        <tr>
            <th>Category</th>
            <th>ID</th>
            <th>Topic</th>
            <th>Date</th>
            <th>Status</th>
            <th>Note</th>
        </tr>
        <tr th:each="entry : ${entries}">
            <td th:text="${entry.topic.category.name}"></td>
            <td th:text="${entry.id}">1</td>
            <td th:text="${entry.topic != null ? entry.topic.name : 'N/A'}"></td>
            <td th:text="${T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd')
                .format(T(java.time.Instant).ofEpochMilli(entry.dateMillisYmd)
                .atZone(zoneId)
                .toLocalDate())}"
                th:title="${entry.dateMillisYmd}"
            >
            <td th:text="${entry.status}"></td>
            <td th:text="${entry.note != null ? entry.note.content : ''}"></td>
        </tr>
    </table>
</div>



<!-- 2) Offcanvas yapısı -->
<div
        class="offcanvas offcanvas-start"
        tabindex="-1"
        id="topicsOffcanvas"
        aria-labelledby="topicsOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="topicsOffcanvasLabel">Add Topics From This Category</h5>
        <button
                type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="topicsOffcanvasBody">
        <!-- İlk açılışta isteği işlenene kadar gösterebileceğiniz bir yükleniyor animasyonu -->
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Yükleniyor…</span>
            </div>
        </div>
    </div>
</div>




<!-- AJAX / JavaScript Kısmı -->


<!-- asagida jquery nin bulunabilmesi ve web gezgini konsolunda hata vermemesi icin maalesef versiyonu da yazdik
cunku zannedersem webjar locator kutuphanesi bunu versiyonsuz bulamiyor.
WebJars path'leri şu yapıyı izler:
/webjars/{artifactId}/{version}/{dosya}
-->
<script type="text/javascript" th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>

<script th:src="@{/webjars/popper.js/umd/popper.min.js}"></script>

<script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.bundle.js}"></script>

<script type="text/javascript" th:src="@{/webjars/htmx.org/dist/htmx.min.js}"></script>

<script type="text/javascript" th:src="@{/webjars/bootstrap-datepicker/dist/js/bootstrap-datepicker.js}"></script>
<!-- online olani: "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" -->

<!-- chart -->
<script type="text/javascript" th:src="@{/webjars/chart.js/4.5.0/dist/chart.umd.js}"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script> -->
<script th:src="@{/js/chartjs-plugin-annotation.js}"></script>





<script>
    function onCategoryChange(categoryId) {
        // Kategori seçilmediyse, topic alanını temizle
        if(!categoryId) {
            const topicsSelect = document.getElementById('topicsSelect');
            topicsSelect.innerHTML = ''; // Tüm optionları temizle
            return;
        }

        // Seçilen kategoriye göre sunucuya AJAX çağrısı
        fetch('/entry-filter/topics-by-category?categoryId=' + categoryId)
            .then(response => response.json())
            .then(data => {
                // data => Topic nesnelerinin listesi (JSON)
                const topicsSelect = document.getElementById('topicsSelect');
                topicsSelect.innerHTML = ''; // Öncekileri temizle

                data.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.text = topic.name;
                    // Varsayılan olarak seçili olsun:
                    option.selected = true;
                    topicsSelect.appendChild(option);
                });

                // Linkleri oluşturup ekrana basalım
                createNewEntryLinks(categoryId, data);
            })
            .catch(err => {
                console.error('Topic getirme hatası', err);
            });
    }


    // Bu metod seçili kategoriye ait topiclerden linkler oluşturur
function createNewEntryLinks(categoryId, topics) {
    const container = document.getElementById('newEntryLinksContainer');

    // Eğer topic yoksa (veya boşsa)
    if (!topics || topics.length === 0) {
        container.innerHTML = "kategori seçtiğinizde entry ekleme linkleri burada görünecektir";
        return;
    }

    // Önce açıklama ekleyelim
    container.innerHTML = "Entry eklemek için tıklayın: ";

    // Topic listesi alfabetik sırala
    topics.sort((a, b) => a.name.localeCompare(b.name));

    // Linkleri oluştur
    const links = topics.map(topic => {
        return `<a href="/entries/new?topicId=${topic.id}&returnPage=pivottable&categoryId=${categoryId}">${topic.name}</a>`;
    }).join(', ');

    // İçeriğe ekleyelim
    container.innerHTML += " " + links;
}

</script>

<script>



   // Her sütun için güncel sıralama yönünü tutar (1 = artan, -1 = azalan)
const pivotSortOrders = {};

function sortPivotTableByColumn(colIndex) {
    const table = document.getElementById("pivot-table");
    if (!table) return;

    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    // Tüm <tr> satırlarını al
    const rowsArray = Array.from(tbody.querySelectorAll("tr"));

    // Bu sütun için önceki sıralama yönünü bul, yoksa varsayılan 1 (artan)
    const sortOrder = pivotSortOrders[colIndex] || 1;

    // Sıralama
    rowsArray.sort((rowA, rowB) => {
        const cellA = rowA.cells[colIndex]?.innerText.trim() || "";
        const cellB = rowB.cells[colIndex]?.innerText.trim() || "";

        if (cellA < cellB) return -1 * sortOrder;
        if (cellA > cellB) return 1 * sortOrder;
        return 0;
    });

    // Yeniden ekle
    rowsArray.forEach(row => tbody.appendChild(row));

    // Bu sütun için yönü tersine çevir
    pivotSortOrders[colIndex] = -sortOrder;
}


    // 1) Tek filtre fonksiyonu: hem topic hem category'yi birlikte kullanır
    function filterPivotTable() {
        const topicInput = document.getElementById("topicSearchBox");
        const categoryInput = document.getElementById("categorySearchBox");
        const topicFilter = topicInput ? topicInput.value.toLowerCase() : "";
        // categoryInput sayfada olmayabilir (conditional), o durumda boş string alır
        const categoryFilter = categoryInput ? categoryInput.value.toLowerCase() : "";

        const table = document.getElementById("pivot-table");
        if (!table) return;
        const tbody = table.querySelector("tbody");
        if (!tbody) return;

        const rows = tbody.querySelectorAll("tr");
        rows.forEach(row => {
            const topicCell = row.cells[0];
            const categoryCell = row.cells[1];

            const topicText = topicCell ? topicCell.innerText.toLowerCase() : "";
            const categoryText = categoryCell ? categoryCell.innerText.toLowerCase() : "";

            // Her iki filtre de eşleşiyorsa göster, değilse gizle
            if (topicText.includes(topicFilter) && categoryText.includes(categoryFilter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

</script>

<!-- 3️⃣ Filtreleme için JS -->
<script>
    (function(){
      const filterInput = document.getElementById('categoryTextFilter');
      const selectEl    = document.getElementById('categorySelect');

      // 1️⃣ Orijinal kategori seçeneklerini (dummy hariç) saklıyoruz
      const dummyOption = { value: '', text: '--Select--' };
      const categoryOptions = Array.from(selectEl.options)
        .filter(opt => opt.value !== '')    // value="" olan dummy'yi at
        .map(opt => ({ value: opt.value, text: opt.text }));

      filterInput.addEventListener('input', function(){
        const term = this.value.trim().toLowerCase();

        // 2️⃣ Select'i temizle
        selectEl.innerHTML = '';

        // 3️⃣ En başa hep dummy seçeneğini ekle
        selectEl.add(new Option(dummyOption.text, dummyOption.value));

        // 4️⃣ Sonra, arama terimine uyan gerçek kategorileri ekle
        categoryOptions
          .filter(({ text }) =>
            term === '' || text.toLowerCase().includes(term)
          )
          .forEach(({ text, value }) => {
            selectEl.add(new Option(text, value));
          });
      });
    })();
</script>


<!-- javascript to keep the label in sync -->
<script>
    function updateThresholdValue() {
      const v = document.getElementById('entriesThreshold').value || 0;
      document.getElementById('thresholdValue').innerText = v;
    }
    function incrementThreshold() {
      const inpt = document.getElementById('entriesThreshold');
      inpt.stepUp();
      updateThresholdValue();
    }
    function decrementThreshold() {
      const inpt = document.getElementById('entriesThreshold');
      inpt.stepDown();
      updateThresholdValue();
    }
    // keep label & input synced if user types manually
    document
      .getElementById('entriesThreshold')
      .addEventListener('input', updateThresholdValue);
</script>





<!-- https://uxsolutions.github.io/bootstrap-datepicker/ -->
<!-- "0,6" means: 0 is Sunday, 6 is Saturday. Comma separated, not range. -->
<!-- calendarWeeks 20 gostermesi gerekirken 21 gosterdi Pazar gunu, disable ettim.  https://www.epochconverter.com/weeknumbers -->
<script>

    $(function() {
      $('#startDateContainer .startDateStyle.date').datepicker({
          format: "yyyy-mm-dd",
          todayBtn: "linked",
          daysOfWeekHighlighted: "0,6",
          calendarWeeks: false,
          autoclose: true,
          todayHighlight: true
      });
  });

    $(function() {
      $('#endDateContainer .endDateStyle.date').datepicker({
          format: "yyyy-mm-dd",
          todayBtn: "linked",
          daysOfWeekHighlighted: "0,6",
          calendarWeeks: false,
          autoclose: true,
          todayHighlight: true
      });
  });


$(document).ready(function () {
    $('#pivot-table .pivot-table-entry-cell').hover(
            function () {
                const $cell = $(this);
                const colIndex = $cell.index();
                const $row = $cell.closest('tr');

                // Aynı satırdaki diğer hücreler (aynı class'a sahip olanlar)
                $row.find('.pivot-table-entry-cell').addClass('highlighted');

                // Aynı sütundaki diğer hücreler
                $('#pivot-table tr').each(function () {
                    $(this).find('.pivot-table-entry-cell').each(function (i, cell) {
                        if ($(cell).index() === colIndex) {
                            $(cell).addClass('highlighted');
                        }
                    });
                });

            },
            function () {
                // Tüm hücrelerden class'ı kaldır
                $('#pivot-table .pivot-table-entry-cell').removeClass('highlighted');
            }
        );
    });
</script>

<!-- Modal yapısı weekly entry calendar icin -->
<script>
    // Modal disina tıklaninca da modali kapatmak icin bu script gerekli cunku kutuphaneli bir modal kullanmadik.
    document.getElementById('modal').addEventListener('click', function (event) {
        const modalContent = document.getElementById('modal-content');
        if (!modalContent.contains(event.target)) {
            this.style.display = 'none';
        }
    });
</script>








</body>
</html>
