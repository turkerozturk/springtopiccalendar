<!-- src/main/resources/templates/category-groups/form.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!--
    This file is part of the DailyTopicTracker project.
    Please refer to the project's README.md file for additional details.
    https://github.com/turkerozturk/springtopiccalendar
    -->
    <meta charset="UTF-8">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">

    <title th:text="${group.id} != null ? 'Edit Group' : 'New Group'">Group Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">

    <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/css/all.min.css}">
</head>
<body class="p-4">
<div class="container">
    <h1 th:text="${group.id} != null ? 'Edit Category Group' : 'New Category Group'">Form</h1>
    <form th:action="@{${group.id} != null
                   ? '/category-groups/edit/' + ${group.id}
                   : '/category-groups/new'}"
          th:object="${group}" method="post">

        <input type="hidden" name="returnPage" th:value="${returnPage}">


        <!-- only include hidden id for edit (optional) -->
        <input type="hidden" th:if="${group.id != null}" th:field="*{id}" />

        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text"
                   id="name"
                   th:field="*{name}"
                   class="form-control"
                   placeholder="Enter unique group name"
                   required autofocus/>
        </div>




        <div class="mb-3">
            <label for="backgroundColor" class="form-label">Color picker</label>
            <input type="color"
                   class="form-control form-control-color"
                   id="backgroundColor"
                   th:field="*{backgroundColor}"
                   title="Choose a color"
            />
        </div>




        <th:block th:if="${imageFilePaths} != null">

            <div class="mb-3">
                <label for="imageFilter" class="form-label">Filter Images:</label>
                <input type="text" id="imageFilter" class="form-control" placeholder="Contains text...">
            </div>

            <div class="mb-3">
                <th:block th:if="${imageFilePaths.size != null && imageFilePaths.size > 0}">
                    <label for="imageFileName" class="form-label">Image File:</label>
                    <select id="imageFileName" th:field="*{imageFileName}" class="form-select" onchange="updatePreview(this)">
                        <option value="" disabled>Select Image</option>
                        <option th:each="path : ${imageFilePaths}"
                                th:value="${path}"
                                th:text="${path}"
                                th:selected="${path}">
                        </option>
                    </select>
                </th:block>
            </div>

            <!-- Highlightlı gösterim -->
            <ul id="highlightList" class="list-group mt-2"></ul>

            <div class="mb-3 mt-2" style="text-align:center;">
                <!-- varsayilan olarak /images/default.png yerine '' var artik cunku resim istenmeyebilir. -->
                <img id="imagePreview" th:src="@{${group.imageFileName != null} ? ${group.imageFileName} : ''}"
                     width="135" height="135" alt="Selected Image" style="object-fit: contain; border: 1px solid #ccc;" />
            </div>

        </th:block>



        <div class="mb-3">
            <p style="color:darkgray;">Note: Priority ordering between category groups is done on the category groups page.</p>
        </div>

        <button type="submit" class="btn btn-success">Save</button>
        <a href="/category-groups" class="btn btn-secondary ms-2">Cancel</a>
    </form>

</div>


<script type="text/javascript"
        th:src="@{/webjars/bootstrap/5.3.7/js/bootstrap.min.js}"></script>

<script>
    function updatePreview(selectElement) {
        const selectedValue = selectElement.value;
        const imagePreview = document.getElementById("imagePreview");
        if (selectedValue && selectedValue.trim() !== "") {
            imagePreview.src = selectedValue;
        } else {
            imagePreview.src = "/images/default.png";
        }
    }
</script>


<script>
    const appLocale = /*[[${appLocale}]]*/ 'en';
    const collator = new Intl.Collator(appLocale, { sensitivity: 'base' });
</script>



<script>
    const filterInput = document.getElementById("imageFilter");
    const select = document.getElementById("imageFileName");
    const highlightList = document.getElementById("highlightList");

    function buildRegex(query) {
        // "meziyet" -> m.*e.*z.*i.*y.*e.*t
        return new RegExp(query.split("").join(".*"), "i");
    }

    filterInput.addEventListener("input", function () {
        const query = this.value.trim();
        const regex = buildRegex(query);
        highlightList.innerHTML = ""; // liste temizle

        Array.from(select.options).forEach((opt, idx) => {
            if (idx === 0) return;

            const fullText = opt.textContent;
            const imagesDir = /*[[${imagesDir}]]*/ 'topicimages';
            const visibleText = fullText.replace(new RegExp("^/" + imagesDir + "/"), "");

            if (regex.test(visibleText)) {
                opt.style.display = "block";

                // highlight: harf harf dolaş
                let qIndex = 0;
                let highlighted = "";
                for (let ch of visibleText) {
                    if (qIndex < query.length &&
                        ch.toLocaleLowerCase() === query[qIndex].toLocaleLowerCase()) {
                        highlighted += `<span style="color:red;font-weight:bold">${ch}</span>`;
                        qIndex++;
                    } else {
                        highlighted += ch;
                    }
                }

                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = highlighted;
                highlightList.appendChild(li);

            } else {
                opt.style.display = "none";
            }
        });
    });
</script>



</body>
</html>
