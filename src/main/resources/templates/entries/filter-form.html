<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Entry Filtre</title>
</head>
<body>
<a href="/">home</a>

<h1>Entry Filtre Formu</h1>

<!-- Validasyon hataları -->
<!-- TODO
<div th:if="${#fields.hasErrors('*')}">
    <p style="color:red" th:each="err : ${#fields.errors('*')}" th:text="${err}"></p>
</div>
-->
<form th:action="@{/entry-filter/apply}" th:object="${filterDto}" method="post">

    <!-- Topic Çoklu -->
    <label>Topic Seçimi (çoklu):</label>
    <select th:field="*{topicIds}" multiple size="5">
        <option th:each="t : ${allTopics}"
                th:value="${t.id}"
                th:text="${t.name}">
        </option>
    </select>
    <br><br>

    <!-- Tarih Aralığı -->
    <label>Başlangıç Tarihi:</label>
    <input type="date" th:field="*{startDate}"/>
    <br><br>

    <label>Bitiş Tarihi:</label>
    <input type="date" th:field="*{endDate}"/>
    <br><br>

    <!-- Status Çoklu -->
    <label>Status (çoklu):</label>
    <select th:field="*{statuses}" multiple size="3">
        <option value="0">Not Marked (0)</option>
        <option value="1">Done (1)</option>
        <option value="2">Warning (2)</option>
    </select>
    <br><br>

    <button type="submit">Filtrele</button>
</form>

<!-- Önceki & Sonraki & Temizle -->
<form th:action="@{/entry-filter/previous}" th:object="${filterDto}" method="post" style="display:inline;">
    <!-- Gizli alanlar -->
    <input type="hidden" th:field="*{topicIds}" />
    <input type="hidden" th:field="*{startDate}" />
    <input type="hidden" th:field="*{endDate}" />
    <input type="hidden" th:field="*{statuses}" />
    <button type="submit">Önceki</button>
</form>

<form th:action="@{/entry-filter/next}" th:object="${filterDto}" method="post" style="display:inline;">
    <!-- Gizli alanlar -->
    <input type="hidden" th:field="*{topicIds}" />
    <input type="hidden" th:field="*{startDate}" />
    <input type="hidden" th:field="*{endDate}" />
    <input type="hidden" th:field="*{statuses}" />
    <button type="submit">Sonraki</button>
</form>

<form th:action="@{/entry-filter/clear}" method="post" style="display:inline;">
    <button type="submit">Temizle</button>
</form>

<hr/>

<!-- Filtre Sonuçları -->






<!-- Düz liste tablo -->

<div th:if="${entries != null}">
    <h2>Sonuçlar</h2>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Topic</th>
            <th>DateMillisYmd</th>
            <th>Status</th>
            <th>Note</th>
        </tr>
        <tr th:each="entry : ${entries}">
            <td th:text="${entry.id}">1</td>
            <td th:text="${entry.topic != null ? entry.topic.name : 'N/A'}"></td>
            <td th:text="${entry.dateMillisYmd}"></td>
            <td th:text="${entry.status}"></td>
            <td th:text="${entry.note != null ? entry.note.content : ''}"></td>
        </tr>
    </table>
</div>


<!-- Pivot tablo -->

<div th:if="${entries != null}">
    <h2>Pivot Tablo</h2>

    <table border="1">
        <!-- Tablonun başlığı (thead) -->
        <thead>
        <tr>
            <th>Topic</th>
            <!-- Tarih sütun başlıkları -->
            <th th:each="day : ${pivotData.dateRange}"
                th:text="${day}">Gün</th>
            <th>Toplam</th>
        </tr>
        </thead>

        <tbody>
        <!-- Her topic için bir satır -->
        <tr th:each="topic : ${pivotData.topicList}">
            <!-- İlk sütun: topic adı -->
            <td th:text="${topic.name}"></td>

            <!-- Ardından pivotData.dateRange kadar hücre -->
            <!-- pivotData.dateRange kadar hücre -->
            <td th:each="day : ${pivotData.dateRange}">

                <!-- 1) entriesForDay isminde bir değişken yaratıyoruz -->
                <div th:with="entriesForDay=${pivotData.pivotMap[topic.id].get(day)}">

                    <!-- 2) Hücredeki entry sayısını gösterelim -->
                    <span th:text="${entriesForDay != null ? entriesForDay.size() : 0}">0</span>

                    <!-- 3) Eğer entriesForDay null değilse, linkleri basalım -->
                    <div th:if="${entriesForDay != null}" th:each="entryItem : ${entriesForDay}">
                        <a th:href="@{/entries/edit/{id}(id=${entryItem.id})}"
                           th:text="${'Entry ' + entryItem.id}"></a>
                        <br/>
                    </div>

                </div>
            </td>


            <!-- Son sütun: o topic'in toplam entry sayısı -->
            <td th:text="${pivotData.topicEntryCount[topic.id] != null ? pivotData.topicEntryCount[topic.id] : 0}"></td>
        </tr>
        </tbody>
    </table>

</div>

</body>
</html>
